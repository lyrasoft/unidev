"use strict";!function(i){var e="singleImageDragUploader",t={crop:!0,export_zoom:1,height:300,max_height:null,max_width:null,min_height:null,min_width:null,origin_size:!1,version:1,width:300,modal_target:""},n=function(e,n){this.element=e,this.options=i.extend(!0,{},t,n),this.fileData=this.element.find(".sid-data"),this.filedrag=this.element.find(".sid-area"),this.fileSelector=this.element.find(".sid-file-select-button"),this.pasteButton=this.element.find(".sid-paste-button"),this.filePreview=this.element.find(".sid-preview"),this.fileLoader=this.element.find(".sid-img-loader"),this.deleteBox=this.element.find(".sid-delete-image"),this.loader=this.element.find(".sid-loader"),this.modal=i(this.options.modal_target),this.cropper=this.modal.find(".sid-cropper"),this.saveButton=this.modal.find(".sid-save-button"),this.bindEvents()};n.prototype={bindEvents:function(){var e,t=this,n=this;this.filedrag.on("dragover",function(e){e.stopPropagation(),e.preventDefault(),i(this).addClass("hover")}),this.filedrag.on("dragleave",function(e){e.stopPropagation(),e.preventDefault(),i(this).removeClass("hover")}),this.cropper.cropit({imageBackground:!0,exportZoom:this.options.export_zoom,onImageError:function(i){swal(Phoenix.Translator.translate("unidev.field.single.image.message.invalid.size.title"),Phoenix.Translator.sprintf("unidev.field.single.image.message.invalid.size.desc",n.options.width,n.options.height),"warning"),n.loader.hide()},onImageLoaded:function(){n.modal.modal("show"),n.loader.hide()},onImageLoading:function(){n.loader.show()}}),n.modal.on("hide.bs.modal",function(){}),this.filedrag.on("drop",function(e){e.stopPropagation(),e.preventDefault(),i(this).removeClass("hover");var t=e.originalEvent.target.files||e.originalEvent.dataTransfer.files;n.handleFileSelect(t[0])}),this.fileSelector.on("click",function(){var e=i('<input type="file">');e.on("change",function(i){var e=i.originalEvent.target.files||i.originalEvent.dataTransfer.files;n.handleFileSelect(e[0])}),e.click()}),this.pasteButton.on("click",function(){navigator.clipboard.read().then(function(i){var e=i[0].types[1];i[0].getType(e).then(function(i){t.handleFileSelect(i)})})}),this.saveButton.on("click",function(){n.saveImage()}),1!==this.options.version&&this.deleteBox.on("change",function(){i(this).is(":checked")?(e=n.fileData.val(),n.fileData.val("")):(n.fileData.val(e),e=null)})},handleFileSelect:function(i){if(this.checkFile(i)){var e=this,t=new FileReader;t.onload=function(t){if(e.options.crop)e.cropper.cropit("imageSrc",t.target.result);else{var n=new Image;n.onload=function(){e.checkSize(n)&&e.saveImage(t.target.result,i.type)},n.src=t.target.result}},t.readAsDataURL(i)}},checkFile:function(i){var e=["image/jpeg","image/png","image/webp"];return!((e=this.options.allow_types||e).indexOf(i.type,e)<0)||(swal(Phoenix.Translator.translate("unidev.field.single.image.message.invalid.image.title"),Phoenix.Translator.translate("unidev.field.single.image.message.invalid.image.desc"),"error"),!1)},checkSize:function(i){try{if(null!==this.options.max_width&&this.options.max_width<i.width)throw new Error(Phoenix.Translator.sprintf("unidev.field.single.image.message.invalid.size.max.width",this.options.max_width));if(null!==this.options.min_width&&this.options.min_width>i.width)throw new Error(Phoenix.Translator.sprintf("unidev.field.single.image.message.invalid.size.min.width",this.options.min_width));if(null!==this.options.max_height&&this.options.max_height<i.height)throw new Error(Phoenix.Translator.sprintf("unidev.field.single.image.message.invalid.size.max.height",this.options.max_height));if(null!==this.options.min_height&&this.options.min_height>i.height)throw new Error(Phoenix.Translator.sprintf("unidev.field.single.image.message.invalid.size.min.height",this.options.min_height))}catch(i){return swal(Phoenix.Translator.translate("unidev.field.single.image.message.invalid.size.title"),i.message,"error"),!1}return!0},saveImage:function(i,e){var t=this;if(e=e||"image/jpeg",i=i||this.cropper.cropit("export",{type:e,quality:.9,originalSize:this.options.origin_size||!1}),this.modal.modal("hide"),this.options.ajax_url)return this.filePreview.attr("src",""),this.filePreview.hide(),this.fileLoader.show(),void this.uploadImage(i).done(function(i){t.storeValue(i.data.url)}).always(function(){t.fileLoader.hide()});t.storeValue(i)},uploadImage:function(e){var t={file:e,format:"base64"};return i.post(this.options.ajax_url,t)},storeValue:function(i){this.fileData.val(i),this.filePreview.attr("src",i),this.filePreview.show(),this.deleteBox.prop("checked",!1),this.fileData.trigger("change"),this.filePreview.trigger("change")}},i.fn[e]=function(t){return i.data(this,"unidev."+e)||i.data(this,"unidev."+e,new n(this,t)),i.data(this,"unidev."+e)}}(jQuery);