{"version":3,"sources":["aws/s3-uploader.js"],"names":["S3Uploader","name","instances","args","options","$","extend","constructor","defaultOptions","file","path","fileData","FormData","Blob","type","File","encodeURIComponent","trimSlashes","subfolder","Object","keys","starts_with","key","append","acl","accessKey","policy","signature","trigger","post","url","endpoint","data","processData","contentType","xhr","XMLHttpRequest","upload","addEventListener","e","lengthComputable","loaded","total","done","res","textStatus","fail","console","error","always","str","replace","PhoenixEventMixin","bucket","region","version"],"mappings":"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","sourcesContent":["/**\n * Part of earth project.\n *\n * @copyright  Copyright (C) 2019 ${ORGANIZATION}.\n * @license    __LICENSE__\n */\n\nclass S3Uploader extends PhoenixEventMixin(class {}) {\n  static defaultOptions = {\n    accessKey: '',\n    bucket: '',\n    acl: '',\n    endpoint: '',\n    region: '',\n    subfolder: '',\n    signature: '',\n    policy: '',\n    version: 2,\n    starts_with: []\n  };\n\n  static instances = {};\n\n  /**\n   * @param {string} name\n   * @param {*}      args\n   *\n   * @returns {S3Uploader}\n   */\n  static getInstance(name, ...args) {\n    if (!this.instances[name]) {\n      this.instances[name] = new this(name, ...args);\n    }\n\n    return this.instances[name];\n  }\n\n  constructor(name, options = {}) {\n    super();\n\n    this.name = name;\n    this.options = $.extend(true, {}, this.constructor.defaultOptions, options);\n  }\n\n  /**\n   * Do upload.\n   *\n   * @param {string|File|Blob} file\n   * @param {string}           path\n   * @param {Object}           options\n   *\n   * @returns {Promise}\n   */\n  upload(file, path, options = {}) {\n    const fileData = new FormData();\n\n    if (typeof file === 'string') {\n      file = new Blob([file], {type: options['Content-Type'] || 'text/plain'});\n    }\n\n    if (file instanceof Blob || file instanceof File) {\n      options['Content-Type'] = options['Content-Type'] || file.type;\n    }\n\n    if (options['filename']) {\n      options['Content-Disposition'] = 'attachment; filename*=UTF-8\\'\\'' + encodeURIComponent(options['filename']);\n    }\n\n    options['key'] = this.constructor.trimSlashes(this.options.subfolder) + '/'\n      + this.constructor.trimSlashes(path);\n    options['Content-Type'] = options['Content-Type'] || 'text/plain';\n    options['Content-Disposition'] = options['Content-Disposition'] || '';\n\n    // Prepare default\n    for (let key of Object.keys(this.options.starts_with)) {\n      fileData.append(key, options[key] || '');\n    }\n\n    fileData.append('acl', this.options.acl);\n    fileData.append('AWSAccessKeyId', this.options.accessKey);\n    fileData.append('policy', this.options.policy);\n    fileData.append('signature', this.options.signature);\n    fileData.append('file', file);\n\n    this.trigger('start', fileData);\n\n    return $.post({\n        url: this.options.endpoint,\n        data: fileData,\n        processData: false,\n        contentType: false,\n        type: 'POST',\n        xhr: () => {\n          const xhr = new XMLHttpRequest();\n\n          if(xhr.upload){\n            xhr.upload.addEventListener('progress', e => {\n              this.trigger('upload-progress', e);\n\n              if (e.lengthComputable) {\n                this.trigger('progress', e.loaded / e.total, e);\n              }\n            }, false);\n          }\n\n          return xhr;\n        },\n      })\n      .done((res, textStatus, xhr) => {\n        const url = this.options.endpoint + '/'\n          + this.constructor.trimSlashes(this.options.subfolder) + '/'\n          + this.constructor.trimSlashes(path);\n\n        this.trigger('success', url, xhr);\n      })\n      .fail((xhr) => {\n        console.error(xhr);\n        this.trigger('fail');\n      })\n      .always(() => {\n        this.trigger('end');\n      });\n  }\n\n  static trimSlashes(str) {\n    return str.replace(/^\\/+|\\/+$/g, '');\n  }\n}\n"],"file":"s3-uploader.js"}